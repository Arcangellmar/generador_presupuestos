<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Propuestas</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f7;
      padding: 40px;
      color: #1c1c1e;
    }

    h1 {
      color: #c62828;
    }

    h2 {
      margin-top: 30px;
      color: #c62828;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 80px;
    }

    button {
      margin-top: 15px;
      padding: 8px 16px;
      background: #c62828;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    button.secondary {
      background: #777;
    }

    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
    }

    th {
      background: #fdeaea;
    }

    .list-item {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .list-item input {
      flex: 1;
    }

    .actions {
      margin-top: 40px;
      text-align: right;
    }

    /* ================= MODAL ================= */

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-content {
      background: #fff;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 30px;
      border-radius: 6px;
      position: relative;
    }

    .close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 18px;
      cursor: pointer;
      color: #c62828;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Dashboard de Propuestas</h1>

<button onclick="abrirModal()">➕ Crear propuesta</button>

<!-- ================= MODAL ================= -->

<div id="modalPropuesta" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal()">✖</span>

    <!-- ================= DATOS GENERALES ================= -->

    <label>Título del Proyecto</label>
    <input id="titulo">

    <label>Cliente</label>
    <input id="cliente">

    <label>Objetivo General</label>
    <textarea id="objetivoGeneral"></textarea>

    <!-- ================= OBJETIVOS ESPECÍFICOS ================= -->

    <h2>Objetivos Específicos</h2>
    <div id="objetivos"></div>
    <button class="secondary" onclick="addItem('objetivos')">+ Agregar objetivo</button>

    <!-- ================= MÓDULOS ================= -->

    <h2>Módulos</h2>
    <div id="modulos"></div>
    <button class="secondary" onclick="addItem('modulos')">+ Agregar módulo</button>

    <!-- ================= PROPUESTA ECONÓMICA ================= -->

    <h2>Propuesta Económica</h2>

    <table>
      <thead>
        <tr>
          <th>Cuota</th>
          <th>Descripción</th>
          <th>Monto (PEN)</th>
        </tr>
      </thead>
      <tbody id="cuotas"></tbody>
    </table>

    <button class="secondary" onclick="agregarCuota()">+ Agregar cuota</button>

    <label>Tipo de cambio (USD → PEN)</label>
    <input id="tipoCambio" type="number" step="0.01" value="3.72">

    <!-- ================= GENERAR ================= -->

    <div class="actions">
      <button onclick="generar()">Generar HTML</button>
    </div>

  </div>
</div>

<!-- ================= SCRIPT ================= -->

<script>
function abrirModal() {
  document.getElementById('modalPropuesta').style.display = 'flex';
}

function cerrarModal() {
  document.getElementById('modalPropuesta').style.display = 'none';
}

async function generar() {
  const plantilla = await fetch('plantilla.html').then(r => r.text());
  const tipoCambio = parseFloat(document.getElementById('tipoCambio').value);

  const data = {
    VAR_TITULO_PROYECTO: document.getElementById('titulo').value,
    VAR_CLIENTE: document.getElementById('cliente').value,
    VAR_OBJETIVO_GENERAL: document.getElementById('objetivoGeneral').value,
    VAR_OBJETIVOS_ESPECIFICOS: generarLista('objetivos'),
    VAR_MODULOS: generarLista('modulos'),
    VAR_TIPO_CAMBIO: tipoCambio.toFixed(2),
    VAR_PROPUESTA_ECONOMICA: generarTablaPropuesta(tipoCambio)
  };

  let htmlFinal = plantilla;

  for (const key in data) {
    htmlFinal = htmlFinal.replace(
      new RegExp(`\\[${key}\\]`, 'g'),
      data[key]
    );
  }

  descargar(htmlFinal);
}

/* ================= LISTAS ================= */

function addItem(id) {
  const div = document.createElement('div');
  div.className = 'list-item';

  const input = document.createElement('input');
  div.appendChild(input);

  document.getElementById(id).appendChild(div);
}

function generarLista(id) {
  const inputs = document.querySelectorAll(`#${id} input`);
  return Array.from(inputs)
    .filter(i => i.value.trim() !== '')
    .map(i => `<li>${i.value}</li>`)
    .join('');
}

/* ================= CUOTAS ================= */

function agregarCuota() {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input placeholder="Cuota 1"></td>
    <td><input placeholder="Descripción"></td>
    <td><input type="number" step="0.01" placeholder="13250"></td>
  `;
  document.getElementById('cuotas').appendChild(tr);
}

function generarTablaPropuesta(tipoCambio) {
  const filas = document.querySelectorAll('#cuotas tr');

  let totalPen = 0;
  let totalUsd = 0;
  let html = '';

  filas.forEach(tr => {
    const inputs = tr.querySelectorAll('input');
    const cuota = inputs[0].value;
    const descripcion = inputs[1].value;
    const pen = parseFloat(inputs[2].value || 0);
    const usd = pen / tipoCambio;

    totalPen += pen;
    totalUsd += usd;

    html += `
<tr>
  <td>${cuota}</td>
  <td>${descripcion}</td>
  <td>S/ ${pen.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
  <td>$ ${usd.toFixed(2)}</td>
</tr>`;
  });

  html += `
<tr class="total-row">
  <td colspan="2">Total del Proyecto</td>
  <td>S/ ${totalPen.toLocaleString('es-PE', { minimumFractionDigits: 2 })}</td>
  <td>$ ${totalUsd.toFixed(2)}</td>
</tr>`;

  return html;
}

/* ================= DESCARGA ================= */

function descargar(contenido) {
  const blob = new Blob([contenido], { type: 'text/html' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'propuesta_generada.html';
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
